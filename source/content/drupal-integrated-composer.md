---
title: Integrated Composer Early Access Documentation
description: Learn how to deploy a Drupal site with integrated Composer
tags: [composer, workflow]
categories: [drupal]
contributors: [edwardangert]
searchboost: 150
reviewed: "2020-04-17"
---

Pantheon is testing a release of Drupal with integrated Composer and is opening the feature to users for Early Access testing. Integrated Composer lets you deploy your site on Pantheon with one-click updates for both upstream commits and Composer dependencies, while still receiving upstream updates.

## Getting Started

<Alert title="Warning" type="danger">

This is Early Access to a feature release, **sites will be deleted without notice**.

Other existing solutions may be a better fit for your long-term needs. For example, if your continuous integration requires automated testing or operations other than running `composer update` or `composer install` see our [Build Tools](/guides/build-tools) guide.

</Alert>

1. Create a repository by forking the Pantheon-maintained repository: [https://github.com/pantheon-upstreams/drupal-project](https://github.com/pantheon-upstreams/drupal-project). For detailed steps see our general documentation how to [Create and Host the Repository Remotely](/create-custom-upstream#create-and-host-the-repository-remotely).
1. Add a new custom upstream on the Pantheon dashboard. For details see [Connect Repository to Pantheon](/create-custom-upstream#connect-repository-to-pantheon).
1. Create a new Drupal 8 site with the site name prefix `ic-demo-2020-` from the upstream to confirm it’s working.
   - This is for testing only. Sites will be deleted without notice.
1. Do not customize the upstream yet.
1. In the Dev environment, install the site.
1. Clone the site locally and run `composer install`.

## Upstream and Site Structure

The upstream has the following directory structure:

```
core/
├─ .gitignore
├─ composer.json
└─ pantheon.upstream.yml
├─ README.md
└─ upstream/
   └─ composer.json
```

- `.gitignore`: Prevents build artifacts generated by Composer from being committed to the upstream or site code repositories.
- `composer.json`: The two different `composer.json` files, allow customization of individual sites without inherent merge conflicts and enable one-click updates.
   - Root-level: Site-level customizations.
   - `upstream/composer.json`: Customizations for the upstream
- `pantheon.upstream.yml`: The `build_step_demo: true` directive in `pantheon.upstream.yml` enables the build step. This name is temporary and will change.

When a site is created, Pantheon runs `composer install`, generates a `composer.lock` file and commits it back to the site’s code repository.

Build artifacts: stored in a git tag (`pantheon_build_artifacts_master`) not the mainline branch (master for Dev or feature branch for Multidev)

## Adding dependencies to your upstream

1. Start with a local clone of your upstream repository.
1. Change into the `upstream` directory.
1. Run:

  ```bash{promptUser: user}
  composer require drupal/pkg-name --no-update
  ```

   - `--no-update` makes Composer run faster

1. Confirm the current configuration version:

  ```bash{outputLines:2}
  composer config version
  1.0.0
  ```

1. Increment the config version number. If you don't increment the version number, updated dependencies will be ignored. Replace `x.y.z` in this example with something like `1.0.1`:

  ```bash{outputLines:2}
  composer config version x.y.z
  ```

1. Commit and push.

## Applying One-click Updates

1. Check for updates.
1. Apply updates.

## Add a Dependency to an Individual Site

1. Clone the git repository from the Pantheon site's dashboard.
1. Run `composer install`:

  ```bash{outputLines:2}
  composer install
  ```

1. Add a new dependency locally:

  ```bash{outputLines:2}
  composer require drupal/pkg-name
  ```

1. Commit `composer.json` and `composer.lock` and push.
   - Pantheon will run Composer, generate build artifacts, and deploy it to your Dev or Multidev environment.
1. Remove dependencies:

  ```bash{outputLines:2}
  composer remove
  ```

## Troubleshooting / FAQ

### What Composer commands does Pantheon run?

- Checking for and applying updates:

  ```bash{outputLines:2}
  composer --no-cache --no-interaction --no-progress --prefer-dist update
  ```

- On all builds except applying updates:

  ```bash{outputLines:2}
  composer --no-cache --no-interaction --no-progress --prefer-dist install
  ```

- When checking for and applying updates:

   - Existing Drupal distro (try with Lightning)
     -Add distro as dependency
   - Try with WordPress (https://roots.io/bedrock/)
   - Apply upstream updates and composer updates to site
   - Apply patches

### How do I view Composer's changes?

Use `git diff` to view changes, excluding composer.lock

```bash{outputLines:2}
git diff d94d1a1179 -- . ':(exclude)composer.lock'
```

Try [composer-lock-diff](https://github.com/davidrjonas/composer-lock-diff) to see what packages have changed after `composer update`
