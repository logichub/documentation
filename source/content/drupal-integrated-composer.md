---
title: Integrated Composer Early Access Documentation
description: Learn how to deploy a Drupal site with integrated Composer.
tags: []
categories: [manage]
contributors: [edwardangert]
searchboost: 150
reviewed: "2020-04-17"
---
localbranch: integrated-composer



Key benefits:
Lean repository & zero build artifacts on the master branch
1-click updates for both upstream commits and Composer dependencies
Integrated build step & no need for 3rd-party integrations
Downstream sites can be customized and continue to receive upstream updates

Sites must be created with `ic-demo-2020-` site name prefix
Sites will be deleted without notice
Only tested with Drupal 8

Other existing solutions may be a better fit for your needs. For example, if your continuous integration requires automated testing or operations other than running Composer update or Composer install see https://pantheon.io/docs/guides/build-tools/

## Getting Started

Create custom upstream & create a new site

Create a repository by forking the Pantheon-maintained repository: https://github.com/pantheon-upstreams/drupal-project. For detailed steps see the general documentation on custom upstreams: Create and Host the Repository Remotely
Add a new custom upstream on the Pantheon dashboard. For details see Connect Repository to Pantheon.
Create a new site with the magic site name prefix `ic-demo-2020` from the upstream to confirm it’s working.
Do this step before customizing your upstream.
Install the site in Dev
Clone the site locally and run `composer install`

## Upstream and Site Structure

The upstream has the following directory structure:

upstream/
   |- composer.json
.gitignore
README.md
composer.json
pantheon.upstream.yml

The two different composer.json files, one at the root-level and one in the upstream directory, allow customization of individual sites without inherent merge conflicts and enable 1-click updates.

Customizations for the upstream live in upstream/composer.json and the root-level composer.json is for site-level customizations.

When a site is created, Pantheon runs `composer install`, generates a composer.lock file and commits it back to the site’s code repository.

The build_step_demo: true directive in pantheon.upstream.yml enables the build step. This name is temporary and will change.

The .gitignore prevents build artifacts generated by Composer from being committed to the upstream or site code repositories.

Build artifacts: stored on a git tag (pantheon_build_artifacts_master) not the mainline branch (master for Dev or feature branch for Multidev)
Adding dependencies to your upstream

Start with a local clone of your upstream repository
Change into the `upstream` directory
Run `composer require drupal/pkg-name --no-update` 
--no-update will make Composer run faster
Run `composer config version` to confirm your current version. You should see output like: `1.0.0`
Run `composer config version x.y.z` to increment the version number. Replace x.y.z with something like 1.0.1. This is an important step, otherwise the updated dependencies will be ignored.
Commit and push

## Applying 1-click updates

Pantheor:
To test dashboard functionality from Admin dashboard:
Open Browser Dev Tools Console  and enter
clientFeatureFlags.updates.enable()  
Refresh dashboard

Make sure to disable afterwards (this is a user level feature flag, not site-level):
clientFeatureFlags.updates.disable()

Check updates
Apply updates

Add dependency to an individual site

Clone git repo from Pantheon site dashboard
Run `composer install`
Add new dependency locally, e.g.
composer require drupal/pkg-name
Commit composer.json and composer.lock and push
Pantheon will run Composer, generate build artifact, and deploy it to your Dev or Multidev 
Remove dep
Composer remove

## Troubleshooting / FAQ

What Composer commands does Pantheon run?

Checking/applying updates:
composer --no-cache --no-interaction --no-progress --prefer-dist update

On all builds except applying updates: composer --no-cache --no-interaction --no-progress --prefer-dist install
When checking for/applying updates: 

Existing Drupal distro (try with Lightning)
Add distro as dependency
Try with WordPress (https://roots.io/bedrock/)
Apply upstream updates and composer updates to site
Apply patches
Troubleshooting / FAQ

Handy things:

See what’s changed, excluding composer.lock
git diff d94d1a1179 -- . ':(exclude)composer.lock'

Looks interesting: https://github.com/davidrjonas/composer-lock-diff

## Known Issues / Open Questions
“Build artifacts added by Pantheon” deploy message on Live, but not Test?
“Build artifacts added by Pantheon” diff crashes dashboard
Git push after local composer require --- long running “Sync code on dev”, no status of “Running composer update”
Git push single commit for composer.lock and composer.json
Apply upstream commit is two commits for composer.lock and composer.json, later is not available to view from Dashboard, with “Merged commits hidden” and link to doc on how to see locally
No error messages when applying upstream updates:
If in SFTP mode, aborts
If composer.json invalid, fails
Blocking modal when applying upstream update?
Make it a Github template? https://help.github.com/en/github/creating-cloning-and-archiving-repositories/creating-a-repository-from-a-template
(out of scope for now) composer require drupal/module-name blocked on https://getpantheon.atlassian.net/browse/CORE-1729
[UnexpectedValueException]
 Invalid version string "‘1.0.1’"
 [Seld\JsonLint\ParsingException]
 "/home/build-user/build/upstream/composer.json" does not contain valid JSON
 Parse error on line 26:
 ...on": "^1.2"        "drupal/bootstrap":
 ---------------------^
 Expected one of: 'EOF', '}', ':', ',', ']'
git pull -X theirs 
Composer doesn’t give any output  until composer.json is updated (composer require)
Applying upstream update with no change to Composer managed files still runs Composer and takes a long time (e.g  pantheon.upstream.yml)
Later
Composer scripts
Handling creds
Autopilot
Adding auto testing

Didn’t want to use upstream -- can we use with root level, custom upstreams
Composer scripts -- 

Debug -- terminus output if composer or not
150 or 100, patch release -- yesterday’s will have blah.1 blah.2
Do not modify upstream/ for site-level

Composer versioning
Composer update -- “nothing to update”  -- manually editing???
